function init(){ich.grabTemplates();drawRows();drawMap(calc_height());addEventListeners()}function drawRows(){$.each(members,function(e,t){t.country=toTitleCase(t.country);var n=ich.table_row(t);$table.append(n)});datatable=$("#members").dataTable()}function drawMap(e){function a(){n=parseInt(d3.select("#map").style("width"));n=n-t.left-t.right;e=n*r;i.translate([n/2-20,e/2+e/50]).scale(n/400*70);u.style("width",n+"px").style("height",e+"px");u.selectAll(".unit").attr("d",s)}var t={top:10,left:10,bottom:10,right:10},n=parseInt(d3.select("#map").style("width")),n=n-t.left-t.right,r=.5,e=n*r;var i=d3.geo.winkel3().scale(n/400*70).translate([n/2-20,e/2+e/50]);var s=d3.geo.path().projection(i);var o=d3.scale.quantile().domain([0,85]).range(d3.range(5).map(function(e){return"q"+e+"-9"}));var u=d3.select("#map").insert("svg:svg","map").attr("width","100%").attr("height",e);d3.json("data/combined.json",function(e,t){u.selectAll(".unit").data(topojson.feature(t,t.objects.combined).features).enter().append("path").attr("class",function(e){var t=e.properties.name;if(totals[t]&&regions[t]){summary_counts[regions[t]]["count"]+=totals[t];region_totals[regions[t]]+=totals[t]}return"unit "+slugify(t)+" "+o(totals[t])}).attr("d",s).on("mouseenter",function(e,t){var n=e.properties.name;if(totals[n]){showBox(e.properties);d3.select(this).classed("hovered",true)}}).on("mouseleave",function(e,t){hideBox();d3.select(this).classed("hovered",false)}).on("click",function(e){if(e.properties.postal){datatable.fnFilter(e.properties.postal)}else{datatable.fnFilter(e.properties.name)}})});d3.select(window).on("resize",a)}function addEventListeners(){$(window).mousemove(function(e){var t=$infobox.parent(),n=t.offset(),r=t.outerWidth()/2;var i=e.pageX-n.left+10,s=e.pageY-n.top+10,o=i>r?i-$infobox.outerWidth()-10:i,u=s;$infobox.css({left:o,top:u})})}function calc_height(){return $map.width()*.5}function showBox(e){$infobox.find("#region").html("Region "+regions[e.name]);$infobox.find("#member-total").html(totals[e.name]);$infobox.find("#location").html(e.name);$infobox.show()}function hideBox(){$infobox.hide()}function slugify(e){return e.replace(/[^-a-zA-Z0-9\s]+/ig,"").replace(/-/gi,"_").replace(/\s/gi,"-").toLowerCase()}function toTitleCase(e){if(e!=="UAE"&&e!=="US"&&e!=="UK"){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}else{return e}}var $table=$("#members"),datatable,$infobox=$("#info-box"),$map=$("#map");var region_totals=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];init();