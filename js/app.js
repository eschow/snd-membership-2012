function init(){ich.grabTemplates();drawRows();drawMap(calc_height());addEventListeners()}function drawRows(){$.each(members,function(e,t){t.country=toTitleCase(t.country);var n=ich.table_row(t);$table.append(n)});datatable=$("#members").dataTable()}function drawMap(e){if($map.find("svg").length>0){d3.select("#map svg").remove()}var t=$map.width();var n=d3.geo.winkel3().scale(t/400*70).translate([t/2-20,e/2+e/50]);var r=d3.scale.quantile().domain([0,85]).range(d3.range(5).map(function(e){return"q"+e+"-9"}));var i=d3.geo.path().projection(n);var s=d3.select("#map").insert("svg:svg","map").attr("width","100%").attr("height",e);d3.json("data/combined.json",function(e,t){s.selectAll(".unit").data(topojson.feature(t,t.objects.combined).features).enter().append("path").attr("class",function(e){var t=e.properties.name;if(totals[t]&&regions[t]){summary_counts[regions[t]]["count"]+=totals[t];region_totals[regions[t]]+=totals[t]}return"unit "+t+" "+r(totals[t])}).attr("d",i).on("mouseenter",function(e){var t=e.properties.name;if(totals[t]){showBox(e.properties)}}).on("mouseleave",function(e){hideBox()}).on("click",function(e){if(e.properties.postal){datatable.fnFilter(e.properties.postal)}else{datatable.fnFilter(e.properties.name)}})});$(window).resize()}function addEventListeners(){$(window).mousemove(function(e){var t=$infobox.parent(),n=t.offset(),r=t.outerWidth()/2;var i=e.pageX-n.left+10,s=e.pageY-n.top+10,o=i>r?i-$infobox.outerWidth()-10:i,u=s;$infobox.css({left:o,top:u})});$(window).resize(function(){if(this.resizeTO)clearTimeout(this.resizeTO);this.resizeTO=setTimeout(function(){$(this).trigger("resizeEnd")},500)});$(window).bind("resizeEnd",function(){var e=calc_height();$("#map svg").css("height",e);drawMap(e);if(this.resizeTO)clearTimeout(this.resizeTO)})}function calc_height(){return $map.width()*.5}function showBox(e){$infobox.find("#region").html("Region "+regions[e.name]);$infobox.find("#member-total").html(totals[e.name]);$infobox.find("#location").html(e.name);$infobox.show()}function hideBox(){$infobox.hide()}function toTitleCase(e){if(e!=="UAE"&&e!=="US"&&e!=="UK"){return e.replace(/\w\S*/g,function(e){return e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()})}else{return e}}var $table=$("#members"),datatable,$infobox=$("#info-box"),$map=$("#map");var region_totals=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];var US_counts={};var abroad_counts={};init();